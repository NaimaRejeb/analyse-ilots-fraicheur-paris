---
title: "PrÃ©traitement des DonnÃ©es"
subtitle: "Nettoyage et prÃ©paration des donnÃ©es brutes"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    code-fold: true
---

# ğŸ§¹ Introduction au PrÃ©traitement

Le prÃ©traitement est une Ã©tape **cruciale** dans tout projet d'analyse de donnÃ©es. Cette page documente les diffÃ©rentes transformations appliquÃ©es aux donnÃ©es brutes des Ã®lots de fraÃ®cheur.

::: {.callout-important}
## Pourquoi prÃ©traiter ?

- Ã‰liminer les **doublons** et donnÃ©es invalides
- Standardiser les **formats** des variables
- CrÃ©er de **nouvelles variables** utiles pour l'analyse
- Garantir la **qualitÃ©** des rÃ©sultats
:::

# ğŸ“¥ DonnÃ©es Brutes

## Chargement initial

```{r echo=TRUE, message=FALSE, warning=FALSE}
# URL du dataset Open Data Paris
url <- "https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/ilots-de-fraicheur-equipements-activites/exports/csv"

# Import des donnÃ©es brutes
donnees_brutes <- read.csv2(url, encoding = "UTF-8", stringsAsFactors = FALSE)

cat("ğŸ“Š DONNÃ‰ES BRUTES\n")
cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
cat("Lignes:", nrow(donnees_brutes), "\n")
cat("Colonnes:", ncol(donnees_brutes), "\n")
```

## AperÃ§u des colonnes

```{r echo=TRUE}
# Liste des colonnes
data.frame(
  Index = 1:ncol(donnees_brutes),
  Colonne = names(donnees_brutes),
  Type = sapply(donnees_brutes, class)
)
```

# ğŸ” Analyse des Valeurs Manquantes

```{r echo=TRUE}
# Analyser les valeurs manquantes
analyse_na <- data.frame(
  Colonne = names(donnees_brutes),
  NA_count = sapply(donnees_brutes, function(x) sum(is.na(x))),
  Vide_count = sapply(donnees_brutes, function(x) sum(x == "", na.rm = TRUE))
)
analyse_na$Pourcentage <- round((analyse_na$NA_count + analyse_na$Vide_count) / nrow(donnees_brutes) * 100, 1)
analyse_na <- analyse_na[order(-analyse_na$Pourcentage), ]

# Afficher les colonnes avec donnÃ©es manquantes
print(analyse_na[analyse_na$Pourcentage > 0, ], row.names = FALSE)
```

::: {.callout-note}
## Observations

- **statut_ouverture** : 94% de valeurs manquantes â†’ peu exploitable
- **horaires_*** : ~77% manquantes â†’ information partielle
- **type** et **payant** : trÃ¨s peu de donnÃ©es manquantes â†’ exploitables
:::

# ğŸ§¼ Ã‰tapes de Nettoyage

## 1. Nettoyage des chaÃ®nes de caractÃ¨res

```{r echo=TRUE}
donnees <- donnees_brutes

# Fonction de nettoyage
nettoyer_texte <- function(x) {
  if (!is.character(x)) return(x)
  x <- trimws(x)                    # Supprimer espaces dÃ©but/fin
  x <- gsub("\\s+", " ", x)         # Remplacer espaces multiples
  x[x == ""] <- NA                  # Convertir vides en NA
  return(x)
}

# Appliquer aux colonnes texte
colonnes_texte <- c("nom", "type", "adresse", "arrondissement", "payant")
for (col in colonnes_texte) {
  if (col %in% names(donnees)) {
    donnees[[col]] <- nettoyer_texte(donnees[[col]])
  }
}

cat("âœ… ChaÃ®nes de caractÃ¨res nettoyÃ©es\n")
```

## 2. Suppression des doublons

```{r echo=TRUE}
# CrÃ©er une clÃ© unique
donnees$cle_unique <- paste(donnees$nom, donnees$adresse, donnees$type, sep = "|")

# Compter les doublons
n_avant <- nrow(donnees)
doublons <- duplicated(donnees$cle_unique)
n_doublons <- sum(doublons)

# Supprimer les doublons
donnees <- donnees[!doublons, ]
donnees$cle_unique <- NULL

cat("ğŸ“‹ SUPPRESSION DES DOUBLONS\n")
cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
cat("Lignes avant:", n_avant, "\n")
cat("Doublons dÃ©tectÃ©s:", n_doublons, "\n")
cat("Lignes aprÃ¨s:", nrow(donnees), "\n")
```

## 3. Extraction des coordonnÃ©es GPS

```{r echo=TRUE}
# Extraire latitude et longitude
if ("geo_point_2d" %in% names(donnees)) {
  coords <- strsplit(as.character(donnees$geo_point_2d), ",")
  donnees$latitude <- as.numeric(sapply(coords, function(x) {
    if (length(x) >= 1) trimws(x[1]) else NA
  }))
  donnees$longitude <- as.numeric(sapply(coords, function(x) {
    if (length(x) >= 2) trimws(x[2]) else NA
  }))
}

# Validation des coordonnÃ©es pour Paris
lat_min <- 48.80; lat_max <- 48.92
lon_min <- 2.22; lon_max <- 2.47

coords_invalides <- which(
  donnees$latitude < lat_min | donnees$latitude > lat_max |
  donnees$longitude < lon_min | donnees$longitude > lon_max
)

cat("ğŸŒ COORDONNÃ‰ES GPS\n")
cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
cat("Points valides:", sum(!is.na(donnees$latitude)), "/", nrow(donnees), "\n")
cat("CoordonnÃ©es hors Paris:", length(coords_invalides), "\n")
```

# ğŸ”§ CrÃ©ation de Nouvelles Variables

## Variables catÃ©gorielles

```{r echo=TRUE}
# Normaliser la colonne "payant"
donnees$payant <- tolower(donnees$payant)
donnees$payant <- ifelse(donnees$payant %in% c("oui", "yes", "1"), "Oui",
                  ifelse(donnees$payant %in% c("non", "no", "0"), "Non", NA))

# Variable binaire
donnees$est_payant <- ifelse(donnees$payant == "Oui", TRUE, FALSE)

# Extraire le numÃ©ro d'arrondissement
donnees$num_arrondissement <- as.integer(gsub("750", "", donnees$arrondissement))

cat("âœ… Variables normalisÃ©es crÃ©Ã©es\n")
```

## Zones gÃ©ographiques

```{r echo=TRUE}
# CrÃ©er des zones de Paris
donnees$zone_paris <- cut(donnees$num_arrondissement,
                          breaks = c(0, 4, 8, 12, 16, 20),
                          labels = c("Centre (1-4)", "Ouest (5-8)", 
                                    "Sud (9-12)", "Sud-Ouest (13-16)", 
                                    "Nord-Est (17-20)"),
                          include.lowest = TRUE)

table(donnees$zone_paris)
```

## CatÃ©gorisation des types

```{r echo=TRUE}
# Fonction de catÃ©gorisation
categoriser_type <- function(type) {
  categorie <- rep("Autre", length(type))
  categorie[grepl("piscine|baignade|bain", type, ignore.case = TRUE)] <- "Aquatique"
  categorie[grepl("brumisateur|fontaine", type, ignore.case = TRUE)] <- "RafraÃ®chissement"
  categorie[grepl("musÃ©e|bibliothÃ¨que|culte", type, ignore.case = TRUE)] <- "BÃ¢timent climatisÃ©"
  categorie[grepl("ombriÃ¨re|ombre", type, ignore.case = TRUE)] <- "Ombrage"
  categorie[grepl("parc|jardin|square|terrain", type, ignore.case = TRUE)] <- "Espace vert"
  categorie[grepl("mairie|dÃ©couverte", type, ignore.case = TRUE)] <- "Service public"
  return(categorie)
}

donnees$categorie <- categoriser_type(donnees$type)
table(donnees$categorie)
```

# ğŸ“Š RÃ©sumÃ© du PrÃ©traitement

```{r echo=TRUE}
resume <- data.frame(
  MÃ©trique = c(
    "Lignes initiales",
    "Lignes aprÃ¨s nettoyage",
    "Doublons supprimÃ©s",
    "Points GPS valides",
    "Types d'Ã©quipements",
    "Arrondissements couverts",
    "Ã‰quipements gratuits",
    "Ã‰quipements payants"
  ),
  Valeur = c(
    nrow(donnees_brutes),
    nrow(donnees),
    n_doublons,
    sum(!is.na(donnees$latitude)),
    length(unique(na.omit(donnees$type))),
    length(unique(na.omit(donnees$arrondissement))),
    sum(donnees$payant == "Non", na.rm = TRUE),
    sum(donnees$payant == "Oui", na.rm = TRUE)
  )
)

print(resume)
```

## Visualisation du rÃ©sumÃ©

```{r echo=TRUE, fig.height=5, fig.width=8}
# Graphique comparatif avant/aprÃ¨s
par(mar = c(5, 10, 4, 2))
barplot(
  c(nrow(donnees_brutes), nrow(donnees), n_doublons),
  names.arg = c("DonnÃ©es brutes", "AprÃ¨s nettoyage", "Doublons supprimÃ©s"),
  horiz = TRUE,
  col = c("#3498db", "#2ecc71", "#e74c3c"),
  main = "Impact du prÃ©traitement sur les donnÃ©es",
  xlab = "Nombre de lignes",
  las = 1
)
```

# ğŸ“ Fichiers GÃ©nÃ©rÃ©s

Le script de prÃ©traitement gÃ©nÃ¨re les fichiers suivants :

| Fichier | Description |
|---------|-------------|
| `data/donnees_nettoyees.csv` | DonnÃ©es complÃ¨tes aprÃ¨s nettoyage |
| `outputs/resume_pretraitement.csv` | RÃ©sumÃ© statistique du prÃ©traitement |
| `outputs/analyse_valeurs_manquantes.csv` | DÃ©tail des valeurs manquantes |

::: {.callout-tip}
## Utilisation des donnÃ©es nettoyÃ©es

Pour les analyses suivantes, utilisez le fichier nettoyÃ© :

```r
donnees <- read.csv("data/donnees_nettoyees.csv", encoding = "UTF-8")
```
:::

---

::: {.callout-important}
## Points clÃ©s du prÃ©traitement

1. **28 doublons supprimÃ©s** â†’ donnÃ©es plus fiables
2. **CoordonnÃ©es GPS validÃ©es** â†’ cartographie prÃ©cise  
3. **Variables enrichies** â†’ analyses plus riches
4. **DonnÃ©es standardisÃ©es** â†’ cohÃ©rence garantie
:::
